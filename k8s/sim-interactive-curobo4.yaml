apiVersion: v1
kind: Pod
metadata:
  name: sim-interactive-curobo4
  namespace: embodied
  labels:
    app: sim-interactive-curobo4
    app.kubernetes.io/component: interactive-sim
    app.kubernetes.io/name: sim-interactive-curobo4
    platform.magics.ai/embodied: "true"
    platform.magics.ai/gpu-index: "2"
spec:
  hostNetwork: true
  nodeName: node1
  restartPolicy: Never
  containers:
  - name: isaac-sim
    image: nvcr.io/nvidia/isaac-sim:4.5.0
    imagePullPolicy: IfNotPresent
    command: ["/bin/bash", "-c"]
    args:
    - |
      set -e
      echo "[startup] $(date) Installing build tools for curobo CUDA extensions..."

      # ---- Install C++ compiler + CUDA 11.8 toolkit ----
      apt-get update -qq 2>/dev/null || true
      apt-get install -y -qq g++ wget ninja-build 2>/dev/null || true

      # Add NVIDIA CUDA repo for 11.8
      if ! dpkg -l cuda-nvcc-11-8 >/dev/null 2>&1; then
        wget -q https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb -O /tmp/cuda-keyring.deb
        dpkg -i /tmp/cuda-keyring.deb 2>/dev/null || true
        apt-get update -qq 2>/dev/null
        apt-get install -y -qq cuda-nvcc-11-8 cuda-cudart-dev-11-8 2>/dev/null
      fi
      export CUDA_HOME=/usr/local/cuda-11.8
      export PATH=$CUDA_HOME/bin:$PATH
      echo "[startup] $(date) CUDA toolkit ready: $(nvcc --version 2>&1 | tail -1)"

      # ---- Install Python deps ----
      /isaac-sim/python.sh -m pip install -q flask pandas pyarrow imageio imageio-ffmpeg tqdm 2>/dev/null || true
      /isaac-sim/python.sh -m pip install -q warp-lang yourdfpy trimesh 2>/dev/null || true

      # ---- Setup curobo ----
      if ls /sim-service/wheels/nvidia_curobo-*.whl >/dev/null 2>&1; then
        export TORCH_CUDA_ARCH_LIST="${TORCH_CUDA_ARCH_LIST:-7.5}"
        /isaac-sim/python.sh -m pip install -q --no-deps /sim-service/wheels/nvidia_curobo-*.whl 2>/dev/null || true
      fi
      if [ -d /sim-service/third_party/curobo/src/curobo ]; then
        export PYTHONPATH="/sim-service/third_party/curobo/src:${PYTHONPATH}"
      fi

      # ---- Pre-compile curobo CUDA extensions ----
      echo "[startup] $(date) Pre-compiling curobo CUDA extensions (this takes ~2-3 min)..."
      /isaac-sim/python.sh - <<'PY'
      import os
      os.environ.setdefault("TORCH_CUDA_ARCH_LIST", "7.5")
      try:
          from curobo.wrap.reacher.motion_gen import MotionGen
          print('[startup] Curobo MotionGen import OK')
      except Exception as exc:
          print(f"[startup] WARNING Curobo MotionGen unavailable: {exc}")
      try:
          from curobo.geom.sdf.world import CollisionCheckerType
          print('[startup] Curobo CollisionCheckerType import OK')
      except Exception as exc:
          print(f"[startup] WARNING: {exc}")
      print(f"[startup] PYTHONPATH={os.environ.get('PYTHONPATH','')}")
      PY
      echo "[startup] $(date) Curobo setup complete, launching Isaac Sim..."

      exec /isaac-sim/python.sh -u /sim-service/run_interactive.py
    env:
    - name: PYTHONUNBUFFERED
      value: "1"
    - name: LIVESTREAM
      value: "2"
    - name: ACCEPT_EULA
      value: "Y"
    - name: PRIVACY_CONSENT
      value: "Y"
    - name: CUDA_VISIBLE_DEVICES
      value: "0"
    - name: HEALTH_PORT
      value: "6904"
    - name: BRIDGE_PORT
      value: "6804"
    - name: WEBRTC_PORT
      value: "49204"
    - name: KIT_API_PORT
      value: "8115"
    - name: MEDIA_PORT
      value: "48104"
    - name: ISAACSIM_PATH
      value: /isaac-sim
    - name: PYTHONPATH
      value: /sim-service
    - name: EMBODIED_DATASETS_ROOT
      value: /data/embodied/dataset/sim
    - name: COLLECT_PLANNER_BACKEND
      value: curobo
    - name: COLLECT_VERBOSE_DEBUG
      value: "1"
    - name: COLLECT_STEP_WORLD_LOG
      value: "1"
    - name: SIM_SCENE_AUTO_LIFT
      value: "1"
    - name: TORCH_CUDA_ARCH_LIST
      value: "7.5"
    - name: CUDA_HOME
      value: /usr/local/cuda-11.8
    ports:
    - containerPort: 6904
      hostPort: 6904
      name: http
      protocol: TCP
    - containerPort: 6804
      hostPort: 6804
      name: bridge-api
      protocol: TCP
    - containerPort: 8115
      hostPort: 8115
      name: kit-api
      protocol: TCP
    - containerPort: 49204
      hostPort: 49204
      name: webrtc-signal
      protocol: TCP
    - containerPort: 48104
      hostPort: 48104
      name: media-udp
      protocol: UDP
    resources:
      requests:
        memory: "8Gi"
        nvidia.com/gpu: "1"
      limits:
        memory: "32Gi"
        nvidia.com/gpu: "1"
    volumeMounts:
    - name: sim-service-code
      mountPath: /sim-service
    - name: data-storage
      mountPath: /data
    - name: scenesmith-data
      mountPath: /scenesmith
    - name: dshm
      mountPath: /dev/shm
    - name: embodied-shared
      mountPath: /data/embodied
  volumes:
  - name: sim-service-code
    hostPath:
      path: /home/magics/sim-service
      type: Directory
  - name: data-storage
    hostPath:
      path: /data
  - name: scenesmith-data
    hostPath:
      path: /home/magics/rlinf-workspace/scenesmith
      type: Directory
  - name: dshm
    emptyDir:
      medium: Memory
      sizeLimit: 16Gi
  - name: embodied-shared
    persistentVolumeClaim:
      claimName: embodied-nfs-pvc
